version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: forgebaselines-nginx
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - forgebaselines
    depends_on:
      - orchestrator
    restart: always

  orchestrator:
    build:
      context: ./services/orchestrator
      dockerfile: Dockerfile
    container_name: forgebaselines-orchestrator
    environment:
      - STORAGE_BACKEND=${STORAGE_BACKEND:-s3}
      - S3_BUCKET=${S3_BUCKET:-forgebaselines-artifacts}
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - CLASSIFICATION_SERVICE_URL=http://classification:8001
      - ENV=production
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
      - FIREBASE_SERVICE_ACCOUNT_JSON=${FIREBASE_SERVICE_ACCOUNT_JSON:-{}}
    volumes:
      - app-data:/app/data
    networks:
      - forgebaselines
    depends_on:
      - mlflow
      - classification
    restart: always

  classification:
    build:
      context: ./services/classification
      dockerfile: Dockerfile
    container_name: forgebaselines-classification
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - ENV=production
    volumes:
      - app-data:/app/data
    networks:
      - forgebaselines
    depends_on:
      - mlflow
    restart: always

  mlflow:
    build:
      context: ./services/mlflow
      dockerfile: Dockerfile
    container_name: forgebaselines-mlflow
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
      - MLFLOW_ARTIFACT_ROOT=${MLFLOW_ARTIFACT_ROOT:-/mlflow-artifacts}
    volumes:
      - mlflow-data:/mlflow
      - mlflow-artifacts:/mlflow-artifacts
    networks:
      - forgebaselines
    restart: always

networks:
  forgebaselines:
    driver: bridge

volumes:
  mlflow-data:
  mlflow-artifacts:
  app-data:
